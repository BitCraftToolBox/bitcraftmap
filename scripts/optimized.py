import json
import numpy as np
import matplotlib.pyplot as plt
from matplotlib.patches import RegularPolygon

npsqrt = np.sqrt(3)

def generate_one_chunk_image(json_data, color_map):

    fig, ax = plt.subplots(figsize=(16, 16))
    array_32_32 = [json_data['biomes'][i*32:(i+1)*32] for i in range(32)]
    values = np.array(array_32_32)
    
    for row in range(32):
        for col in range(32):

            x = col * npsqrt
            y = row * (2 * 3/4)
            if row % 2 == 1:
                x += npsqrt / 2

            val = values[row, col]
            val = val if val in range(15) else 0
            color = color_map[val]

            hexagon = RegularPolygon(
                (x, y),
                numVertices = 6,
                radius = 1,
                orientation = 0,
                facecolor = color,
                edgecolor = 'none',
                antialiased = False
            )
            ax.add_patch(hexagon)

    # Place any text in the hex maybe useful later
    # ax.text(x, y, str(values[row, col]), ha='center', va='center', fontsize=10)

    # Set limits to avoid trimming
    ax.set_xlim(-npsqrt / 2, npsqrt * (32 + 0.5)) # Math Sorcery
    ax.set_ylim(-1, 2 * (32 * 3/4 + 0.25))        # Math Sorcery
    ax.set_aspect('equal')                        # Makes the aspect ratio of height and width the same
    ax.axis('off')                                # Remove legend on the sides

    ax.set_title(
        'X: ' + str(json_data['chunk_x']) + ' Y: ' + str(json_data['chunk_z']),
        {'fontsize': 100, 'fontweight': 100}
    
    )

    chunk_filename = 'assets/maps/chunks/r8/chunk_' + str(json_data['chunk_x']) + '_' + str(json_data['chunk_z']) + '.png'

    plt.savefig(
        chunk_filename,
        dpi = 150,
        bbox_inches = 'tight',
        pad_inches = 0,
        transparent = True
    )
    plt.close(fig)
    plt.close()

biomes_colors = [
    '#FF0000', # Dev
    '#404932', # Calm Forest
    '#53584b', # Pine Woods
    '#b1b1af', # Snowy Peaks
    '#616147', # Breezy Grasslands
    '#484133', # Autumn Forest
    '#615257', # Misty Tundra
    '#72674d', # Desert Wasteland
    '#354540', # Swamp
    '#4c4956', # Rocky Garden
    '#282f41', # Open Ocean
    '#656d53', # Safe Meadows
    '#222222', # Cave
    '#495943', # Jungle
    '#473d4c' # Sapwoods
]

example_chunk = {
    "chunk_x": 119,
    "chunk_z": 203,
    "biomes": [11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,267,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,267,2817,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,11,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,1,1,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,11,11,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,11,11,11,11,11,11,11,11,11,11,11,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,11,11,11,11,11,267,267,267,267,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,11,11,11,11,267,267,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,11,11,11,11,267,267,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,267,267,267,267,267,267,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,267,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,267,267,267,267,267,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,267,267,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2817,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2817,2817,2817,2817,2817,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,2817,2817,2817,2817,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
}

# generate_one_chunk_image(example_chunk, biomes_colors)


with open('assets/data/terrain_chunk_state/region_8/terrain_chunk_state_new.json', 'r', encoding='utf-8') as file:
    data = json.load(file)
    for chunk in data:
       generate_one_chunk_image(chunk, biomes_colors)