<!DOCTYPE html>
<html>
	<head>
		<title>Bitcraft Game Map</title>
    <link rel="icon" type="image/x-icon" href="assets/icons/MapCompass.png">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
		<link rel="stylesheet" href="assets/search/leaflet-search.src.css" crossorigin=""/>
		<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script src="https://rawgit.com/kawanet/msgpack-lite/master/dist/msgpack.min.js" crossorigin=""></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-canvas-marker@0.2.0/dist/leaflet.canvas-markers.min.js" crossorigin=""></script>
		<script src="assets/search/leaflet-search.src.js" crossorigin=""></script>


		<style>
      html, body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        height: 100%;
      }
			#map {
				height: 100vh;
				width: 100%;
        background-color: #222d44;
			}
      #coords {
        position: absolute;
        bottom: 10px;
        left: 10px;
        background: white;
        padding: 5px 10px;
        z-index: 1000;
        font-family: monospace;
	      border-radius:.25em;
      }
    </style>
	</head>

	<body>
		<div id="map"></div>
		<div id="coords"></div>

		<script>

			const imageWidth = 7676;
			const imageHeight = 7676;
			const imageBounds = [[0, 0], [imageHeight, imageWidth]];
			
      const map = L.map('map', {
        crs: L.CRS.Simple,
        minZoom: -3,
        maxZoom: 5,
        zoomSnap: 0.1,
        attributionControl: false,
        zoomControl: false,
        preferCanvas: true,
        boxZoom: true
      }).setView([0.5 * imageHeight / 1.15, 0.5 * imageWidth], 0);
			
			L.imageOverlay('assets/maps/map.png', imageBounds).addTo(map);

      function createMapIcon(iconUrl, iconSize = [32, 32], iconAnchor = [16, 16], popupAnchor = [0, -16]) {
        return L.icon({
          iconUrl: iconUrl,
          iconSize: iconSize,
          iconAnchor: iconAnchor,
          popupAnchor: popupAnchor,
          shadowUrl: null,
          shadowSize: null,
          shadowAnchor: null
        });
      }
 
      const caveIcons = [
        createMapIcon('assets/icons/FerralithOreChunk.webp'),
        createMapIcon('assets/icons/PyreliteOreChunk.webp'),
        createMapIcon('assets/icons/EmariumOreChunk.webp'),
        createMapIcon('assets/icons/ElenvarOreChunk.webp'),
        createMapIcon('assets/icons/LuminiteOreChunk.webp'),
        createMapIcon('assets/icons/RathiumOreChunk.webp'),
        createMapIcon('assets/icons/AurumiteOreChunk.webp'),
        createMapIcon('assets/icons/CelestiumOreChunk.webp'),
        createMapIcon('assets/icons/UmbraciteOreChunk.webp'),
        createMapIcon('assets/icons/AstraliteOreChunk.webp')
      ];

      const claimIcons = [
        createMapIcon('assets/icons/claim_t0.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t1.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t2.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t3.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t4.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t5.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t6.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t7.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t8.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t9.png',  [44, 44], [22, 22], [0, -22]),
        createMapIcon('assets/icons/claim_t10.png', [44, 44], [22, 22], [0, -22])
      ];

      const ruinedIcon = createMapIcon('assets/icons/ruined.png',  [44, 44], [22, 22], [0, -22]);
      const templeIcon = createMapIcon('assets/icons/temple.svg');
      const treeIcon = createMapIcon('assets/icons/tree.svg');

      const oreTier = [
        'Ferralith','Pyrelite','Emarium','Elenvar','Luminite',
        'Rathium','Aurumite','Celestium','Umbracite','Astralite'
      ];


      // For later
      const caveSize = ['Small','Large'];
      const poiLayers = ["ruinedCities", "playerClaims","empireTowers", "temples", "wonders", "caves"];
      const resourcesLayers = ["wildAnimals", "monsters","hieroglyphs", "fibers", "trees", "ores", "sand", "stone", "clay", "berry", "flower", "mushroom", "fishBait", "fishLake", "fishOcean"];
      const miscLayers = ["jakylsDens", "travelersFruits","wildFoods", "sticks", "flint"];

      const cavesLayer = L.layerGroup();
      const treesLayer = L.layerGroup();
      const ruinedLayer = L.layerGroup();
      const templesLayer = L.layerGroup();

      const caveT1Layer = L.layerGroup();
      const caveT2Layer = L.layerGroup();
      const caveT3Layer = L.layerGroup();
      const caveT4Layer = L.layerGroup();
      const caveT5Layer = L.layerGroup();
      const caveT6Layer = L.layerGroup();
      const caveT7Layer = L.layerGroup();
      const caveT8Layer = L.layerGroup();
      const caveT9Layer = L.layerGroup();
      const caveT10Layer = L.layerGroup();

      const bankLayer = L.layerGroup();
      const marketLayer = L.layerGroup();
      const waystoneLayer = L.layerGroup();

      const claimT0Layer = L.layerGroup();
      const claimT1Layer = L.layerGroup();
      const claimT2Layer = L.layerGroup();
      const claimT3Layer = L.layerGroup();
      const claimT4Layer = L.layerGroup();
      const claimT5Layer = L.layerGroup();
      const claimT6Layer = L.layerGroup();
      const claimT7Layer = L.layerGroup();
      const claimT8Layer = L.layerGroup();
      const claimT9Layer = L.layerGroup();
      const claimT10Layer = L.layerGroup();

      const allClaims = L.layerGroup([
        claimT0Layer,
        claimT1Layer,
        claimT2Layer,
        claimT3Layer,
        claimT4Layer,
        claimT5Layer,
        claimT6Layer,
        claimT7Layer,
        claimT8Layer,
        claimT9Layer,
        claimT10Layer
      ]);

      const allCaves = L.layerGroup([
        caveT1Layer,
        caveT2Layer,
        caveT3Layer,
        caveT4Layer,
        caveT5Layer,
        caveT6Layer,
        caveT7Layer,
        caveT8Layer,
        caveT9Layer,
        caveT10Layer
      ]);

      const caveLayers = [
        caveT1Layer, caveT2Layer, caveT3Layer, caveT4Layer, caveT5Layer,
        caveT6Layer, caveT7Layer, caveT8Layer, caveT9Layer, caveT10Layer
      ];

      const claimLayers = [
        claimT0Layer, claimT1Layer, claimT2Layer, claimT3Layer, claimT4Layer, claimT5Layer,
        claimT6Layer, claimT7Layer, claimT8Layer, claimT9Layer, claimT10Layer
      ];

      // Todo
      calculateExpiration = function(updatedAT, tiles, supplies) {
        suppliesPerMin = 0;

        if (tiles < 1001)  { suppliesPerMin = tiles * 0.01 * 60   } else
        if (tiles < 2001)  { suppliesPerMin = tiles * 0.0125 * 60 } else
        if (tiles < 3001)  { suppliesPerMin = tiles * 0.02 * 60   } else 
        if (tiles < 4001)  { suppliesPerMin = tiles * 0.025 * 60  } else 
        if (tiles < 6001)  { suppliesPerMin = tiles * 0.03 * 60   } else 
        if (tiles < 8001)  { suppliesPerMin = tiles * 0.035 * 60  } else 
        if (tiles < 10001) { suppliesPerMin = tiles * 0.04 * 60   } else 
        if (tiles < 13001) { suppliesPerMin = tiles * 0.05 * 60   } else 
        if (tiles < 16001) { suppliesPerMin = tiles * 0.06 * 60   }
        else { suppliesPerMin = tiles * 0.07 * 60 }

      }

      const overlayMaps = {
        "Wonders": treesLayer,
        "Temples": templesLayer,
        "Ruined Cities": ruinedLayer,

        "Banks": bankLayer,
        "Markets": marketLayer,
        "Waystones": waystoneLayer,
      };

      const overlayCaves = {
        "Caves T1": caveT1Layer,
        "Caves T2": caveT2Layer,
        "Caves T3": caveT3Layer,
        "Caves T4": caveT4Layer,
        "Caves T5": caveT5Layer,
        "Caves T6": caveT6Layer,
        "Caves T7": caveT7Layer,
        "Caves T8": caveT8Layer,
        "Caves T9": caveT9Layer,
        "Caves T10": caveT10Layer
      }

      const cavesToggle = {
        "Caves": allCaves
      }

      const overlayClaims = {
        
        "Claims T0": claimT0Layer,
        "Claims T1": claimT1Layer,
        "Claims T2": claimT2Layer,
        "Claims T3": claimT3Layer,
        "Claims T4": claimT4Layer,
        "Claims T5": claimT5Layer,
        "Claims T6": claimT6Layer,
        "Claims T7": claimT7Layer,
        "Claims T8": claimT8Layer,
        "Claims T9": claimT9Layer,
        "Claims T10": claimT10Layer
      }

      const claimsToggle = {
        "Claims": allClaims
      }

      treesLayer.addTo(map);
      templesLayer.addTo(map);
      ruinedLayer.addTo(map);

      L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);
      L.control.layers(null, cavesToggle, { collapsed: false }).addTo(map);
      L.control.layers(null, overlayCaves, { collapsed: false }).addTo(map);
      L.control.layers(null, claimsToggle, { collapsed: false }).addTo(map);
      L.control.layers(null, overlayClaims, { collapsed: false }).addTo(map);
      const controlSearch = new L.Control.Search({
        position:'topleft',		
        layer: allClaims,
        initial: false,
        marker: false,
        firstTipSubmit: true,
        // markerLocation: true,
        // hideMarkerOnCollapse: true,
        zoom: 2
      });

      map.addControl(controlSearch);

      controlSearch.on('search:locationfound', function(e) {
        if (!map.hasLayer(allClaims)) {
          map.addLayer(allClaims);
        }
      });

      fetch('assets/markers/trees.msgpack')
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const data = msgpack.decode(new Uint8Array(buffer));
        data.forEach(node => {
          const pos_e = Math.round(node[1]);
          const pos_n = Math.round(node[2]);
          const text = 'Traveler\'s Tree</br>N '+ pos_n + ' E ' + pos_e;
          // Magic number 1.1547005
          L.marker([pos_n / 1.1547005, pos_e], {icon: treeIcon})
          .bindPopup(text)
          .addTo(treesLayer);
        });
      });

      fetch('assets/markers/temples.msgpack')
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const data = msgpack.decode(new Uint8Array(buffer));
        data.forEach(node => {
          const pos_e = Math.round(node[1]);
          const pos_n = Math.round(node[2]);
          const text = node[3] + '</br>N '+ pos_n + ' E ' + pos_e;
          // Magic number 1.1547005
          L.marker([pos_n / 1.1547005, pos_e], {icon: templeIcon})
          .bindPopup(text)
          .addTo(templesLayer);
        });
      });

      fetch('assets/markers/ruined.msgpack')
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const data = msgpack.decode(new Uint8Array(buffer));
        data.forEach(node => {
          const pos_e = Math.round(node[1]);
          const pos_n = Math.round(node[2]);
          const text = node[3] + '</br>N '+ pos_n + ' E ' + pos_e;
          // Magic number 1.1547005
          L.marker([pos_n / 1.1547005, pos_e], {icon: ruinedIcon})
          .bindPopup(text)
          .addTo(ruinedLayer);
        });
      });

      fetch('assets/markers/caves.msgpack')
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const data = msgpack.decode(new Uint8Array(buffer));
        data.forEach(node => {
          const pos_e = Math.round(node[1]);
          const pos_n = Math.round(node[2]);
          const tierIndex = node[4] - 1;

          const text = 
            caveSize[node[3]-1] + ' ' + oreTier[node[4]-1] + ' Cave'
            + '</br>N '+ pos_n + ' E ' + pos_e;
          // Magic number 1.1547005
          L.marker([pos_n / 1.1547005, pos_e], {icon: caveIcons[node[4]-1]})
          .bindPopup(text)
          .addTo(caveLayers[tierIndex]);
        });
      });

      fetch('assets/markers/claims.msgpack')
      .then(response => response.arrayBuffer())
      .then(buffer => {
        const data = msgpack.decode(new Uint8Array(buffer));
        data.forEach(node => {
          const pos_e = Math.round(node[1] / 23040 * 7676);
          const pos_n = Math.round(node[2] / 23040 * 7676);

          const name = node[3] + ' (T' + node[4] + ')' + '</br>';
          const loc = 'N '+ pos_n + ' E ' + pos_e + '</br>';
          const tiles = 'Tiles : ' + node[6] + '</br>';
          const supplies = 'Supplies : ' + node[7] + '</br>';
          const has_bank = 'Bank : ' + (node[9] ? 'Yes' : 'No') + '</br>';
          const has_market = 'Market : ' + (node[10] ? 'Yes' : 'No') + '</br>';
          const has_Waystone = 'Waystone : ' + (node[11] ? 'Yes' : 'No');

          const text = name + loc + tiles + supplies + has_bank + has_market + has_Waystone 

          // Magic number 1.1547005
          const marker = L.marker([pos_n / 1.1547005, pos_e], {title: node[3], icon: claimIcons[node[4]]});
          marker.bindPopup(text);
        
          marker.addTo(claimLayers[node[4]]);

          if (node[9]) {
            marker.addTo(bankLayer)
          }
          if (node[10]) {
            marker.addTo(marketLayer)
          }
          if (node[11]) {
            marker.addTo(waystoneLayer)
          }
        });
      });

      const coordDisplay = document.getElementById('coords');

      map.on('mousemove', function (e) {
        const coordN = Math.round(e.latlng.lat * 1.1547005);
        const coordE = e.latlng.lng.toFixed(0);
        coordDisplay.innerText = `N : ${coordN}, E: ${coordE}`;
      });
		</script>
	</body>
</html>
